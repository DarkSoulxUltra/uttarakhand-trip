<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Uttarakhand Trip Planner</title>

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#67e8f9}
h1{text-align:center;color:#22d3ee;margin:12px 0}
.container{max-width:1400px;margin:auto;padding:12px}

/* ROUTE BAR */
.routeBox{border:1px solid #164e63;border-radius:14px;padding:14px;margin-bottom:14px;position:relative}
.routeTitle{text-align:center;font-weight:600;color:#22d3ee;margin-bottom:8px}
.routeActions{position:absolute;top:10px;right:12px;display:flex;gap:8px}
.routeActions button{padding:4px 8px;font-size:12px}

.routeLine{position:relative;display:flex;justify-content:space-between;align-items:center;height:36px}
.routeLine::before{content:"";position:absolute;left:0;right:0;top:50%;height:3px;background:#164e63}
.node{width:18px;height:18px;background:#164e63;border-radius:50%;cursor:pointer;position:relative}
.node.active{background:#22d3ee;box-shadow:0 0 8px #22d3ee}
.node:hover::after{
  content:attr(data-tip);
  position:absolute;top:-26px;left:50%;transform:translateX(-50%);
  background:#020617;border:1px solid #164e63;
  padding:2px 6px;font-size:11px;border-radius:4px;white-space:nowrap
}
.vehicle{position:absolute;top:-22px;transition:.4s}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media(max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.grid{grid-template-columns:1fr}}

/* CARDS */
.sectionCard{border:1px solid #164e63;border-radius:12px;overflow:hidden}
.sectionHeader{
  padding:10px;
  font-weight:600;
  cursor:pointer;
  border-bottom:1px solid #164e63;
  display:flex;
  justify-content:space-between;
  align-items:center;
  user-select:none;
}
.sectionHeader:active{background:#041428}
.sectionBody{display:none;padding:10px}
.sectionCard.expanded .sectionBody{display:block}

input,textarea,select{
  width:100%;margin:4px 0;padding:6px;border-radius:6px;border:none
}
button{
  background:#22d3ee;border:none;border-radius:6px;
  padding:6px 10px;cursor:pointer
}
ul{padding-left:18px}
.log{font-size:12px;border-top:1px dashed #164e63;margin-top:6px;padding-top:6px}
.smallBtn{font-size:12px;padding:2px 6px}
</style>
</head>

<body>
<div class="container">
<h1>Uttarakhand Trip Planner</h1>

<!-- ROUTE -->
<div class="routeBox">
  <div class="routeTitle" id="routeTitle"></div>
  <div class="routeActions">
    <button onclick="expandAll()">Expand all</button>
    <button onclick="collapseAll()">Collapse all</button>
  </div>
  <div class="routeLine">
    <div id="vehicle" class="vehicle">üöå</div>
    <div class="node" onclick="selectDay(0)"></div>
    <div class="node" onclick="selectDay(1)"></div>
    <div class="node" onclick="selectDay(2)"></div>
    <div class="node" onclick="selectDay(3)"></div>
    <div class="node" onclick="selectDay(4)"></div>
    <div class="node" onclick="selectDay(5)"></div>
  </div>
</div>

<div class="grid" id="content"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc,
  onSnapshot, updateDoc, arrayUnion
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBqiBMggvuMxAiKfBpJIqnv8OCWj76voAk",
  authDomain: "trip-planner-2026.firebaseapp.com",
  projectId: "trip-planner-2026",
  storageBucket: "trip-planner-2026.appspot.com",
  messagingSenderId: "118349993233",
  appId: "1:118349993233:web:7edb1de869796188a428b0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DATA */
const tripDates=["Sun","Mon","Tue","Wed","Thu","Fri"];
const days=[
 {city:"Delhi ‚Üí Haridwar",steps:["Arrive Delhi","Bus to Haridwar","Ganga Aarti"],
  route:"https://www.google.com/maps?q=Delhi+to+Haridwar&output=embed",
  hotel:"Hotel Ganga Lahari",
  emergency:["Ambulance 108","Police 112","District Hospital Haridwar"],
  food:["Local chai","Chotiwala"]
 },
 {city:"Haridwar ‚Üí Rishikesh",steps:["Early snan","Mansa Devi","Travel to Rishikesh"],
  route:"https://www.google.com/maps?q=Haridwar+to+Rishikesh&output=embed",
  hotel:"Tapovan Resort",
  emergency:["AIIMS Rishikesh"],
  food:["German Bakery"]
 },
 {city:"Rishikesh",steps:["Ram Jhula","Laxman Jhula","Cafes"],
  route:"https://www.google.com/maps?q=Tapovan+Rishikesh&output=embed",
  hotel:"Tapovan Stay",
  emergency:["AIIMS Rishikesh"],
  food:["Beatles Cafe"]
 },
 {city:"Rishikesh",steps:["Rafting","Rest","Ghat walk"],
  route:"https://www.google.com/maps?q=Rishikesh+rafting&output=embed",
  hotel:"Tapovan Stay",
  emergency:["AIIMS Rishikesh"],
  food:["Local snacks"]
 },
 {city:"Rishikesh ‚Üí Dehradun",steps:["Neergarh","Drive to DDN"],
  route:"https://www.google.com/maps?q=Rishikesh+to+Dehradun&output=embed",
  hotel:"Hotel Pacific Dehradun",
  emergency:["DDN District Hospital"],
  food:["Ellora Bakery"]
 },
 {city:"Mussoorie ‚Üí Delhi",steps:["Mall Road","Return to Delhi"],
  route:"https://www.google.com/maps?q=Mussoorie+to+Delhi&output=embed",
  hotel:"‚Äî",
  emergency:["‚Äî"],
  food:["‚Äî"]
 }
];

/* STATE */
const tripId=new URLSearchParams(location.search).get("trip")||"default-trip";
const tripRef=doc(db,"trips",tripId);

let activeDay=0;
let cardsExpanded=false;
let participants=[];
let notes={};
let expenses={};
let activityLog=[];
let showLog=false;

/* INIT */
async function initTrip(){
  const snap=await getDoc(tripRef);
  if(!snap.exists()){
    await setDoc(tripRef,{participants:["Sahil","Patil"],notes:{},activityLog:[]});
  }
}

onSnapshot(tripRef,s=>{
  const d=s.data();
  participants=d.participants||[];
  notes=d.notes||{};
  activityLog=d.activityLog||[];
  render();
});

for(let i=0;i<days.length;i++){
  const ref=doc(db,"trips",tripId,"expenses","day-"+i);
  onSnapshot(ref,s=>{
    expenses[i]=s.exists()?s.data().items:[];
    render();
  });
}

/* ACTIONS */
window.selectDay=i=>{activeDay=i;render()}
window.expandAll=()=>{cardsExpanded=true;render()}
window.collapseAll=()=>{cardsExpanded=false;render()}
window.toggleLog=()=>{showLog=!showLog;render()}

/* RENDER */
function render(){
  const d=days[activeDay];
  routeTitle.innerText=`${tripDates[activeDay]} ‚Äî ${d.city}`;

  document.querySelectorAll(".node").forEach((n,i)=>{
    n.classList.toggle("active",i===activeDay);
    n.dataset.tip=`${tripDates[i]} ‚Äî ${days[i].city}`;
  });

  vehicle.style.left=`calc(${activeDay*(100/(days.length-1))}% - 10px)`;

  content.innerHTML=buildCards(d);
  attachCardHandlers();
}

function buildCards(d){
  return `
    ${card("üß≠ Step-by-step",`<ul>${d.steps.map(s=>`<li>${s}</li>`).join("")}</ul>`)}
    ${card("üó∫ Route Map",`<iframe src="${d.route}" width="100%" height="200"></iframe>`)}
    ${card("üè® Hotel",`<b>${d.hotel}</b>`)}
    ${card("üìù Notes",`<textarea oninput="saveNote(this.value)">${notes[activeDay]||""}</textarea>`)}
    ${card("üí≥ Expenses",expensesHTML())}
    ${card("üìä Settlement",`Total ‚Çπ${(expenses[activeDay]||[]).reduce((a,b)=>a+b.amount,0)}`)}
    ${card("üöë Emergency",`<ul>${d.emergency.map(e=>`<li>${e}</li>`).join("")}</ul>`)}
    ${card("‚òï Food & Snacks",`<ul>${d.food.map(f=>`<li>${f}</li>`).join("")}</ul>`)}
  `;
}

function card(title,body){
  return `
  <div class="sectionCard ${cardsExpanded?"expanded":""}">
    <div class="sectionHeader">${title}</div>
    <div class="sectionBody">${body}</div>
  </div>`;
}

function attachCardHandlers(){
  document.querySelectorAll(".sectionHeader").forEach(h=>{
    h.onclick=()=>{
      h.parentElement.classList.toggle("expanded");
    };
  });
}

/* EXPENSES */
function expensesHTML(){
  return `
    <input id="et" placeholder="Title">
    <input id="ea" type="number" placeholder="Amount">
    <select id="ep">${participants.map(p=>`<option>${p}</option>`).join("")}</select>
    <button onclick="addExpense()">Add</button>
    ${(expenses[activeDay]||[]).map((e,i)=>`
      <div>${e.title} ‚Çπ${e.amount} (${e.paidBy})
      <button class="smallBtn" onclick="delExpense(${i})">‚ùå</button></div>`).join("")}
    <button class="smallBtn" onclick="toggleLog()">üïò Log</button>
    ${showLog?`<div class="log">${activityLog.map(l=>
      `<div>[${l.type}] Day ${l.day+1} ‚Äì ${l.title} ‚Çπ${l.amount}</div>`
    ).join("")}</div>`:""}
  `;
}

window.saveNote=async v=>{
  notes[activeDay]=v;
  await setDoc(tripRef,{notes},{merge:true});
};

window.addExpense=async ()=>{
  const t=et.value,a=+ea.value,p=ep.value;
  if(!t||!a)return;
  const list=[...(expenses[activeDay]||[]),{title:t,amount:a,paidBy:p}];
  await setDoc(doc(db,"trips",tripId,"expenses","day-"+activeDay),{items:list});
  await updateDoc(tripRef,{activityLog:arrayUnion({
    type:"ADD",day:activeDay,title:t,amount:a,by:p,ts:Date.now()
  })});
};

window.delExpense=async idx=>{
  const item=expenses[activeDay][idx];
  const list=expenses[activeDay].filter((_,i)=>i!==idx);
  await setDoc(doc(db,"trips",tripId,"expenses","day-"+activeDay),{items:list});
  await updateDoc(tripRef,{activityLog:arrayUnion({
    type:"DELETE",day:activeDay,title:item.title,amount:item.amount,by:item.paidBy,ts:Date.now()
  })});
};

initTrip();
render();
</script>
</body>
</html>
