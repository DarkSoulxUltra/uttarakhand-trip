<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Uttarakhand Trip Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root{
  --bg:#020617;
  --card:#020b1f;
  --border:#164e63;
  --accent:#22d3ee;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:linear-gradient(180deg,#020617,#020617);
  color:#e5faff;
}
h1{text-align:center;color:var(--accent)}
.container{max-width:1300px;margin:auto;padding:16px}
.route{
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
  margin-bottom:16px;
}
.routeLine{
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:relative;
}
.routeLine::before{
  content:"";
  position:absolute;
  left:0;right:0;top:50%;
  height:3px;
  background:var(--border);
}
.node{
  width:14px;height:14px;border-radius:50%;
  background:#155e75;z-index:2;
}
.node.active{background:var(--accent)}
.bus{font-size:18px;margin-right:6px}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:14px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  transition:.25s;
}
.card:hover{box-shadow:0 0 14px rgba(34,211,238,.25)}
.card h3{margin:0 0 8px;color:var(--accent)}

input,select,textarea,button{
  width:100%;
  padding:8px;
  margin:4px 0;
  border-radius:8px;
  border:none;
}
button{
  background:var(--accent);
  color:#022c22;
  font-weight:600;
  cursor:pointer;
}
.log{font-size:13px;border-bottom:1px dashed var(--border);padding:4px 0}
iframe{width:100%;height:220px;border-radius:10px;border:none}
.remove{background:#ff4d4d;color:white}
</style>
</head>

<body>
<div class="container">

<h1>Uttarakhand Trip Planner</h1>

<div class="route">
  <div class="routeLine" id="routeLine"></div>
  <div style="text-align:center;margin-top:6px" id="routeTitle"></div>
</div>

<div class="grid" id="content"></div>

</div>

<!-- FIREBASE -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqiBMggvuMxAiKfBpJIqnv8OCWj76voAk",
  authDomain: "trip-planner-2026.firebaseapp.com",
  projectId: "trip-planner-2026"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- APP STATE ---------- */
const tripId = new URLSearchParams(location.search).get("trip") || "uttarakhand-mar-2026";
const tripDates=["Sun","Mon","Tue","Wed","Thu","Fri"];

let activeDay=0;
let expenses=[];
let participants=["Sahil","Patil"];
let notes={};
let logs=[];
let currentUser = null;


/* ---------- TRIP DATA ---------- */
const days=[
{
    city:"Delhi â†’ Haridwar",
    steps:["Arrive Delhi","Bus to Haridwar","Hotel check-in","Ganga Aarti"],
    routeMap:"https://www.google.com/maps?q=Delhi+to+Haridwar&output=embed",
    hotel:{
      name:"Hotel near Har Ki Pauri",
      link:"https://maps.google.com/?q=Har+Ki+Pauri+Haridwar",
      map:"https://www.google.com/maps?q=Har+Ki+Pauri+Haridwar&output=embed"
    },
    food:["Local chai","Chotiwala"],
    emergency:["Ambulance:108","Police:112"]
  },
  {
    city:"Haridwar â†’ Rishikesh",
    steps:["Morning Aarti","Travel","Explore ghats"],
    routeMap:"https://www.google.com/maps?q=Haridwar+to+Rishikesh&output=embed",
    hotel:{
      name:"Hotel in Tapovan",
      link:"https://maps.google.com/?q=Tapovan+Rishikesh",
      map:"https://www.google.com/maps?q=Tapovan+Rishikesh&output=embed"
    },
    food:["German Bakery","Cafe"],
    emergency:["Ambulance:108","Police:112"]
  },
  {
    city:"Rishikesh",
    steps:["Rafting","Cafes","Ashrams"],
    routeMap:"https://www.google.com/maps?q=Rishikesh&output=embed",
    hotel:{
      name:"Same Hotel",
      link:"#",
      map:"https://www.google.com/maps?q=Tapovan+Rishikesh&output=embed"
    },
    food:["Snacks"],
    emergency:["108"]
  },
  {
    city:"Rishikesh",
    steps:["Waterfall","Rest"],
    routeMap:"https://www.google.com/maps?q=Neer+Waterfall+Rishikesh&output=embed",
    hotel:{
      name:"Same Hotel",
      link:"#",
      map:"https://www.google.com/maps?q=Tapovan+Rishikesh&output=embed"
    },
    food:["Tea"],
    emergency:["108"]
  },
  {
    city:"Rishikesh â†’ Dehradun",
    steps:["Travel","Explore"],
    routeMap:"https://www.google.com/maps?q=Rishikesh+to+Dehradun&output=embed",
    hotel:{
      name:"Hotel in Dehradun",
      link:"#",
      map:"https://www.google.com/maps?q=Dehradun&output=embed"
    },
    food:["Street food"],
    emergency:["108"]
  },
  {
    city:"Mussoorie â†’ Delhi",
    steps:["Sightseeing","Return"],
    routeMap:"https://www.google.com/maps?q=Mussoorie&output=embed",
    hotel:{
      name:"Day Trip",
      link:"#",
      map:"https://www.google.com/maps?q=Mussoorie&output=embed"
    },
    food:["Cafe"],
    emergency:["108"]
  }
];

/* ---------- FIREBASE ---------- */
const ref=doc(db,"trips",tripId);

function saveTrip(){
  setDoc(ref,{
    expenses,
    participants,
    notes,
    logs,
    updatedAt:Date.now()
  });
}

onSnapshot(ref,s=>{
  if(!s.exists())return;
  const d=s.data();
  expenses = Array.isArray(d.expenses)
  ? d.expenses
  : Object.values(d.expenses || {}).flat();

  participants=d.participants||[];
  notes=d.notes||{};
  logs=d.logs||[];
  render();
});

/* ---------- LOGIC ---------- */
function addLog(text){
  logs.push({
    text,
    by: currentUser,
    time: Date.now()
  });
}
function setCurrentUser(name){
  currentUser = name;
  saveTrip();
}


function addExpense(){
  const t=document.getElementById("et").value;
  const a=parseInt(document.getElementById("ea").value);
  const p=document.getElementById("ep").value;
  if(!t||!a)return;
  const exp={id:crypto.randomUUID(),title:t,amount:a,paidBy:p,day:activeDay};
  expenses.push(exp);
  addLog(`${currentUser} added â‚¹${a} for ${t} (${tripDates[activeDay]})`);
  saveTrip();
}

function delExpense(id){
  let exp = expenses.find(e => e.id === id);
  if (!exp) exp = expenses.find(e => e.title); // legacy fallback
  expenses = expenses.filter(e => e !== exp);
  if(exp){
    addLog(`${currentUser} removed â‚¹${exp.amount} for ${exp.title} (${tripDates[exp.day] || ""})`);
  }
  saveTrip();
}

function addMember() {
  const input = document.getElementById("memberName");
  const name = input.value.trim();
  if (!currentUser) currentUser = name;
  if (!name) return;
  if (participants.includes(name)) return;

  participants.push(name);
  input.value = "";

  logs.push(`${name} joined the trip`);
  saveTrip(); // ğŸ”¥ THIS IS REQUIRED
}

function removeMember(name) {
  participants = participants.filter(p => p !== name);

  logs.push(`${name} was removed from the trip`);
  saveTrip(); // ğŸ”¥ THIS IS REQUIRED
}

  
function calculateSettlement(){
  let total=0,paid={};
  participants.forEach(p=>paid[p]=0);
  expenses.forEach(e=>{
    total+=e.amount;
    paid[e.paidBy]+=e.amount;
  });
  const share=total/participants.length;
  let result={};
  participants.forEach(p=>result[p]=Math.round(paid[p]-share));
  return {total,share,result};
}

function attachFirebaseListeners() {
  db.collection("trips").doc(tripId)
    .onSnapshot(doc => {
      if (!doc.exists) return;

      const data = doc.data();

      expenses = Array.isArray(data.expenses)
        ? data.expenses
        : Object.values(data.expenses || {}).flat();

      participants = data.participants || [];
      notes = data.notes || {};
      logs = data.logs || [];

      render();
    });
}


 function renderMembers() {
  const box = document.getElementById("memberList");
  if (!box) return;

  box.innerHTML = participants.length
    ? participants.map(m => `
        <div class="pill">
          ${m}
          <button onclick="removeMember('${m}')">âŒ</button>
        </div>
      `).join("")
    : "<i>No members yet</i>";
}
 
/* ---------- UI ---------- */
function render(){
  const d=days[activeDay];
  document.getElementById("routeTitle").innerText=
    `${tripDates[activeDay]} â€” ${d.city}`;

  const rl=document.getElementById("routeLine");
  rl.innerHTML="";
  days.forEach((_,i)=>{
    const n=document.createElement("div");
    n.className="node"+(i===activeDay?" active":"");
    n.onclick=()=>{activeDay=i;render()};
    rl.appendChild(n);
  });

  const {total,share,result}=calculateSettlement();

  document.getElementById("content").innerHTML=`
  <div class="card"><h3>ğŸ§­ Step-by-step</h3><ul>${d.steps.map(s=>`<li>${s}</li>`).join("")}</ul></div>
  <div class="card">
  <h3>ğŸ—º Route Map</h3>
  ${
    d.routeMap
      ? `<iframe src="${d.routeMap}" loading="lazy"></iframe>`
      : "No route map available"
  }
</div>
  <div class="card">
  <h3>ğŸ¨ Hotel</h3>
  ${
    d.hotel
      ? `
        <b>${d.hotel.name}</b><br>
        <a href="${d.hotel.link}" target="_blank">Open in Maps</a>
        <iframe src="${d.hotel.map}" loading="lazy"></iframe>
      `
      : "No hotel for this day"
  }
</div>
  <div class="card">
  <h3>ğŸ½ Food & Snacks</h3>
  <ul>
    ${(d.food || []).map(f => `<li>${f}</li>`).join("")}
  </ul>
</div>

  <div class="card"><h3>ğŸ“ Notes</h3><textarea>${notes[activeDay]||""}</textarea><button onclick="notes[activeDay]=this.previousSibling.value;saveTrip()">Save Notes</button></div>
  <div class="card">
  <h3>ğŸš¨ Emergency</h3>
  <ul>
    ${(d.emergency || []).map(e => `<li>${e}</li>`).join("")}
  </ul>
</div>

  <div class="card">
  <h3>ğŸ‘¥ Members</h3>
  <input id="memberName" placeholder="Name">
  <button onclick="addMember()">Add</button>

  <div id="memberList"></div>
</div>

  <div class="card"><h3>ğŸ’³ Expenses</h3>
    <input id="et" placeholder="Title">
    <input id="ea" type="number" placeholder="Amount">
    <select id="ep">${participants.map(p=>`<option>${p}</option>`).join("")}</select>
    <button onclick="addExpense()">Add</button>
    ${expenses.map(e=>`<div>${e.title} â‚¹${e.amount} (${e.paidBy}) <button class="remove" onclick="delExpense('${e.id}')">X</button></div>`).join("")}
  </div>
  <div class="card"><h3>ğŸ“Š Settlement</h3>
    Total â‚¹${total}<br>Per Person â‚¹${Math.round(share)}
    ${Object.entries(result).map(([p,v])=>`<div>${v>0?"ğŸŸ¢":"ğŸ”´"} ${p} ${v>0?"gets":"pays"} â‚¹${Math.abs(v)}</div>`).join("")}
  </div>
  <div class="card"><h3>ğŸ§¾ Logs</h3>${logs.length
  ? logs.map(l =>
      `<div class="log">
        [${new Date(l.time).toLocaleString()}] ${l.text}
      </div>`
    ).join("")
  : "No logs yet"
}
</div>
  `;
renderMembers();
}

  // ğŸ”— Expose functions for inline HTML handlers
window.addExpense = addExpense;
window.delExpense = delExpense;
window.addMember = addMember;
window.removeMember = removeMember;
window.saveNotes = saveNotes;


render();
</script>
</body>
</html>
