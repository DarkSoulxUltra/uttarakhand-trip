<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Uttarakhand Trip Planner</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: radial-gradient(circle at top, #020617, #000);
  color: #67e8f9;
}

h1 {
  text-align: center;
  margin: 16px 0;
  color: #22d3ee;
}

.container {
  max-width: 1400px;
  margin: auto;
  padding: 12px;
}

/* ROUTE BAR */
.routeBar {
  border: 1px solid #164e63;
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 16px;
}

.routeLine {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.routeLine::before {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  top: 50%;
  height: 3px;
  background: #164e63;
}

.routeDot {
  width: 18px;
  height: 18px;
  background: #164e63;
  border-radius: 50%;
  z-index: 2;
  cursor: pointer;
}

.routeDot.active {
  background: #22d3ee;
  box-shadow: 0 0 10px #22d3ee;
}

.bus {
  position: absolute;
  top: -26px;
  transition: 0.4s;
}

/* GRID */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 14px;
}

/* CARDS */
.card {
  border: 1px solid #164e63;
  border-radius: 14px;
  overflow: hidden;
}

.cardHeader {
  padding: 10px;
  font-weight: 600;
  cursor: pointer;
  background: rgba(2,6,23,0.8);
}

.cardHeader:hover {
  background: rgba(34,211,238,0.15);
}

.cardBody {
  display: none;
  padding: 10px;
}

.card.open .cardBody {
  display: block;
}

button {
  background: #22d3ee;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  font-weight: 600;
  cursor: pointer;
}

input, select, textarea {
  width: 100%;
  margin: 4px 0;
  padding: 6px;
  border-radius: 6px;
  border: none;
}

.log {
  font-size: 13px;
  color: #a5f3fc;
}
</style>
</head>

<body>
<div class="container">
<h1>Uttarakhand Trip Planner</h1>

<div class="routeBar">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <b id="dayTitle"></b>
    <div>
      <button onclick="expandAll()">Expand all</button>
      <button onclick="collapseAll()">Collapse all</button>
    </div>
  </div>

  <div class="routeLine" id="routeLine">
    <div class="bus" id="bus">üöå</div>
  </div>
</div>

<div class="grid" id="cards"></div>
</div>

<script>
/* ===================== FIREBASE ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyBqiBMggvuMxAiKfBpJIqnv8OCWj76voAk",
  authDomain: "trip-planner-2026.firebaseapp.com",
  projectId: "trip-planner-2026"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===================== STATE ===================== */
const params = new URLSearchParams(location.search);
const tripId = params.get("trip") || "default-trip";

const days = [
  { label:"Sun", title:"Delhi ‚Üí Haridwar",
    steps:["Arrive Delhi","Bus to Haridwar","Ganga Aarti"],
    hotel:"Hotel Ganga Lahari",
    emergency:["Ambulance 108","Police 112","District Hospital Haridwar"],
    food:["Local chai","Chotiwala"]
  },
  { label:"Mon", title:"Haridwar ‚Üí Rishikesh",
    steps:["Morning snaan","Mansa Devi","Travel to Rishikesh"],
    hotel:"Tapovan Stay",
    emergency:["AIIMS Rishikesh","Police 112"],
    food:["German Bakery","Cafe 60s"]
  }
];

let activeDay = 0;
let expensesByDay = {};
let logs = [];
let expandState = localStorage.getItem("expandAll")==="true";

/* ===================== FIRESTORE ===================== */
function dayRef(d){
  return db.collection("trips").doc(tripId)
           .collection("days").doc(String(d));
}

function logsRef(){
  return db.collection("trips").doc(tripId).collection("logs");
}

days.forEach((_,d)=>{
  dayRef(d).onSnapshot(s=>{
    expensesByDay[d] = s.data()?.expenses || [];
    render();
  });
});

logsRef().orderBy("ts","desc").onSnapshot(s=>{
  logs = s.docs.map(d=>d.data());
  render();
});

/* ===================== UI ===================== */
function toggleCard(el){
  el.parentElement.classList.toggle("open");
}

function expandAll(){
  expandState = true;
  localStorage.setItem("expandAll","true");
  document.querySelectorAll(".card").forEach(c=>c.classList.add("open"));
}

function collapseAll(){
  expandState = false;
  localStorage.setItem("expandAll","false");
  document.querySelectorAll(".card").forEach(c=>c.classList.remove("open"));
}

/* ===================== EXPENSE ===================== */
async function addExpense(){
  const t = document.getElementById("et").value;
  const a = Number(document.getElementById("ea").value);
  const p = document.getElementById("ep").value;
  if(!t || !a) return;

  const list = expensesByDay[activeDay] || [];
  list.push({title:t,amount:a,paidBy:p});

  await dayRef(activeDay).set({expenses:list},{merge:true});
  await logsRef().add({msg:`Added ${t} ‚Çπ${a}`,ts:Date.now()});
}

async function delExpense(i){
  const list = expensesByDay[activeDay];
  const removed = list.splice(i,1)[0];
  await dayRef(activeDay).set({expenses:list},{merge:true});
  await logsRef().add({msg:`Removed ${removed.title}`,ts:Date.now()});
}

/* ===================== RENDER ===================== */
function render(){
  document.getElementById("dayTitle").innerText =
    `${days[activeDay].label} ‚Äî ${days[activeDay].title}`;

  const route = document.getElementById("routeLine");
  route.innerHTML = `<div class="bus" id="bus">üöå</div>`;
  days.forEach((d,i)=>{
    const dot = document.createElement("div");
    dot.className = "routeDot"+(i===activeDay?" active":"");
    dot.title = d.title;
    dot.onclick = ()=>{activeDay=i;render();};
    route.appendChild(dot);
  });
  document.getElementById("bus").style.left =
    `calc(${activeDay*(100/(days.length-1))}% - 10px)`;

  const d = days[activeDay];
  const ex = expensesByDay[activeDay] || [];
  const total = ex.reduce((s,e)=>s+Number(e.amount||0),0);

  const cards = document.getElementById("cards");
  cards.innerHTML = `
${card("üß≠ Step-by-step", `<ul>${d.steps.map(s=>`<li>${s}</li>`).join("")}</ul>`)}
${card("üè® Hotel", d.hotel)}
${card("üöë Emergency", `<ul>${d.emergency.map(e=>`<li>${e}</li>`).join("")}</ul>`)}
${card("‚òï Food & Snacks", `<ul>${d.food.map(f=>`<li>${f}</li>`).join("")}</ul>`)}
${card("üí≥ Expenses", `
<input id="et" placeholder="Title">
<input id="ea" type="number" placeholder="Amount">
<select id="ep"><option>Sahil</option><option>Patil</option></select>
<button onclick="addExpense()">Add</button>
<hr>
${ex.map((e,i)=>`
<div>${e.title} ‚Çπ${e.amount} (${e.paidBy})
<button onclick="delExpense(${i})">‚ùå</button></div>`).join("")}
`)}
${card("üìä Settlement", `Total ‚Çπ${total}`)}
${card("üìù Logs", logs.map(l=>`<div class="log">${l.msg}</div>`).join("") )}
`;

  if(expandState) expandAll();
}

function card(title, body){
  return `
<div class="card ${expandState?"open":""}">
  <div class="cardHeader" onclick="toggleCard(this)">${title}</div>
  <div class="cardBody">${body}</div>
</div>`;
}

render();
</script>
</body>
</html>
